---
/**
 * Gallery Image Component with AVIF Support
 * Optimized for project galleries with progressive loading
 */
import { getImage } from 'astro:assets';

interface Props {
  src: string;
  alt: string;
  index: number;
  loading?: 'lazy' | 'eager';
}

const {
  src,
  alt,
  index,
  loading = index < 3 ? 'eager' : 'lazy' // First 3 images load eagerly
} = Astro.props;

// Generate thumbnail versions for gallery grid
const avifThumb = await getImage({
  src,
  format: 'avif',
  width: 400,
  height: 300,
  quality: 75
});

const webpThumb = await getImage({
  src,
  format: 'webp',
  width: 400,
  height: 300,
  quality: 75
});

const jpegThumb = await getImage({
  src,
  format: 'jpeg',
  width: 400,
  height: 300,
  quality: 80
});

// High resolution for retina displays
const avifThumb2x = await getImage({
  src,
  format: 'avif',
  width: 800,
  height: 600,
  quality: 70
});

const webpThumb2x = await getImage({
  src,
  format: 'webp',
  width: 800,
  height: 600,
  quality: 70
});
---

<button
  type="button"
  class="gallery-image-item"
  data-index={index}
  data-full-src={src}
  aria-label={`View ${alt}`}
>
  <picture>
    <!-- AVIF format -->
    <source
      type="image/avif"
      srcset={`${avifThumb.src} 1x, ${avifThumb2x.src} 2x`}
    />

    <!-- WebP format -->
    <source
      type="image/webp"
      srcset={`${webpThumb.src} 1x, ${webpThumb2x.src} 2x`}
    />

    <!-- JPEG fallback -->
    <img
      src={jpegThumb.src}
      alt={alt}
      width="400"
      height="300"
      loading={loading}
      decoding="async"
    />
  </picture>

  <div class="image-loading-spinner" aria-hidden="true">
    <svg viewBox="0 0 50 50">
      <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="3"></circle>
    </svg>
  </div>
</button>

<style>
  .gallery-image-item {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    padding: 0;
    background: #f0f0f0;
    transition: all 0.3s ease;
  }

  .gallery-image-item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .gallery-image-item picture {
    display: block;
    width: 100%;
    height: 100%;
  }

  .gallery-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }

  /* Loading state */
  .gallery-image-item:not(.loaded) img {
    opacity: 0;
  }

  .gallery-image-item.loaded img {
    opacity: 1;
  }

  .gallery-image-item.loaded .image-loading-spinner {
    display: none;
  }

  /* Loading spinner */
  .image-loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    color: #f27a5e;
  }

  .image-loading-spinner svg {
    animation: rotate 1s linear infinite;
  }

  .image-loading-spinner circle {
    stroke-dasharray: 125;
    stroke-dashoffset: 125;
    animation: dash 1.5s ease-in-out infinite;
  }

  @keyframes rotate {
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes dash {
    0% {
      stroke-dashoffset: 125;
    }
    50% {
      stroke-dashoffset: 31;
    }
    100% {
      stroke-dashoffset: 125;
    }
  }
</style>

<script>
  // Mark images as loaded when they finish loading
  document.addEventListener('DOMContentLoaded', () => {
    const galleryItems = document.querySelectorAll('.gallery-image-item');

    galleryItems.forEach((item) => {
      const img = item.querySelector('img');

      if (img) {
        if (img.complete) {
          item.classList.add('loaded');
        } else {
          img.addEventListener('load', () => {
            item.classList.add('loaded');
          }, { once: true });
        }
      }
    });
  });
</script>