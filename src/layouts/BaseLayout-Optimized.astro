---
import { ViewTransitions } from 'astro:transitions';
import SEO from '../components/SEO.astro';
import Header from '../components/Header-Optimized.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title: string;
  description: string;
  ogImage?: string;
  canonicalURL?: string;
  schema?: object;
  noindex?: boolean;
  article?: {
    publishedTime?: string;
    modifiedTime?: string;
  };
}

const {
  title,
  description,
  ogImage = '/og-image.jpg',
  canonicalURL = Astro.url.href,
  schema,
  noindex = false,
  article
} = Astro.props;
---

<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />

    <!-- Enhanced SEO Component -->
    <SEO
      title={title}
      description={description}
      canonical={canonicalURL}
      ogImage={ogImage}
      noindex={noindex}
      article={article}
      schema={schema}
    />

    <!-- View Transitions for smooth page navigation -->
    <ViewTransitions />

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Font loading -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Critical CSS Variables -->
    <style>
      :root {
        /* Colors */
        --navy-dark: #1a2c4d;
        --blue-primary: #2563eb;
        --blue-hover: #1d4ed8;
        --coral-accent: #f27a5e;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-600: #4b5563;
        --gray-900: #111827;
        --white: #ffffff;

        /* Typography */
        --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
        --text-base: 1rem;
        --text-sm: 0.875rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        --text-4xl: 2.25rem;

        /* Spacing */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;
        --space-10: 2.5rem;
        --space-12: 3rem;
        --space-16: 4rem;
        --space-20: 5rem;

        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-base: 200ms ease;
        --transition-slow: 300ms ease;

        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);

        /* Border radius */
        --rounded-sm: 0.125rem;
        --rounded: 0.25rem;
        --rounded-md: 0.375rem;
        --rounded-lg: 0.5rem;
        --rounded-xl: 0.75rem;
        --rounded-full: 9999px;
      }

      /* Base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        font-family: var(--font-sans);
        line-height: 1.6;
        color: var(--gray-900);
        background: var(--white);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1;
      }

      /* Image loading styles for consolidated detector */
      img {
        opacity: 0;
        transition: opacity var(--transition-slow);
      }

      img.loaded {
        opacity: 1;
      }

      img.error {
        opacity: 0.5;
      }

      /* Accessibility */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      /* Focus styles */
      :focus-visible {
        outline: 2px solid var(--blue-primary);
        outline-offset: 2px;
      }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
          scroll-behavior: auto !important;
        }
      }

      /* Print styles */
      @media print {
        header,
        footer,
        nav {
          display: none;
        }
      }
    </style>

    <!-- Slot for page-specific head content -->
    <slot name="head" />
  </head>
  <body>
    <!-- Optimized Header with conditional mobile menu loading -->
    <Header />

    <main id="main" tabindex="-1">
      <slot />
    </main>

    <Footer />

    <!--
      PERFORMANCE OPTIMIZATIONS:
      1. Image load detection is consolidated and uses client:idle
      2. Mobile menu JavaScript only loads on mobile devices
      3. Scripts use IntersectionObserver for better performance
    -->

    <!-- Consolidated image load detection (loaded when browser is idle) -->
    <script>
      // Load image detector when browser is idle
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
          import('../scripts/image-load-detector.js');
        });
      } else {
        // Fallback for browsers without requestIdleCallback
        setTimeout(() => {
          import('../scripts/image-load-detector.js');
        }, 1);
      }
    </script>

    <!-- Analytics (if needed) - Also loaded when idle -->
    <script>
      // Example: Google Analytics or other analytics
      // Only load after main content is ready
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
          // Load analytics here
          // Example: import('../scripts/analytics.js');
        });
      }
    </script>

    <!-- Slot for page-specific scripts -->
    <slot name="scripts" />
  </body>
</html>