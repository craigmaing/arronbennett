---
/**
 * Optimized Image Component
 * Handles WebP conversion, lazy loading, and responsive images
 * Uses Astro's built-in Image optimization with Sharp
 */
import { Image } from 'astro:assets';

interface Props {
  src: string | ImageMetadata;
  alt: string;
  width: number;
  height: number;
  sizes?: string;
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'sync' | 'auto';
  class?: string;
  format?: 'avif' | 'webp' | 'png' | 'jpg';
  quality?: number;
}

const {
  src,
  alt,
  width,
  height,
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  loading = 'lazy',
  decoding = 'async',
  class: className,
  format = 'avif', // Default to AVIF for best compression
  quality = 80
} = Astro.props;

// Validate alt text (accessibility requirement)
if (!alt || alt.trim() === '') {
  console.warn(`Missing alt text for image: ${typeof src === 'string' ? src : 'imported image'}`);
}
---

<Image
  src={src}
  alt={alt}
  width={width}
  height={height}
  format={format}
  quality={quality}
  loading={loading}
  decoding={decoding}
  sizes={sizes}
  class={className}
  densities={[1, 2]}
/>

<style>
  img {
    /* Prevent layout shift */
    aspect-ratio: var(--aspect-ratio);

    /* Smooth image loading */
    transition: opacity 0.3s ease-in-out;
  }

  /* Fade in when loaded */
  img[loading="lazy"] {
    opacity: 0;
  }

  img[loading="lazy"].loaded {
    opacity: 1;
  }
</style>

<script>
  // Add loaded class when image loads (for fade-in effect)
  document.querySelectorAll('img[loading="lazy"]').forEach((img) => {
    if (img.complete) {
      img.classList.add('loaded');
    } else {
      img.addEventListener('load', () => {
        img.classList.add('loaded');
      });
    }
  });
</script>
